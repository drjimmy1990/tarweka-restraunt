
-- =============================================
-- ROBUST RESTAURANT MANAGEMENT SYSTEM SCHEMA (v4.0)
-- =============================================

-- 1. ENUMS
-- Defines strict types for data integrity
CREATE TYPE order_status AS ENUM ('pending', 'accepted', 'in_kitchen', 'out_for_delivery', 'done', 'cancelled');
CREATE TYPE user_role AS ENUM ('super_admin', 'branch_manager');
CREATE TYPE payment_method AS ENUM ('cash', 'credit_card', 'wallet');
CREATE TYPE payment_status AS ENUM ('pending', 'paid', 'failed', 'refunded');

-- 2. SYSTEM USERS
-- Staff members with access to the dashboard
CREATE TABLE system_users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL, -- In production, store BCRYPT hash only
    role user_role NOT NULL, 
    full_name TEXT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE, -- Ability to ban a user without deleting history
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 3. BRANCHES
-- Physical locations. 'is_active' determines if they appear in the Ray Casting algorithm.
CREATE TABLE branches (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    manager_id BIGINT REFERENCES system_users(id),
    name TEXT NOT NULL,
    phone_contact TEXT,
    
    -- Geospatial Data
    zones JSONB NOT NULL DEFAULT '[]', -- The polygon definitions and fees
    
    -- Operational Status
    is_active BOOLEAN DEFAULT TRUE, -- Global switch to turn off branch
    opening_time TIME, -- For validation (optional)
    closing_time TIME, -- For validation (optional)
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 4. CUSTOMERS
-- End-users interacting via Chatbot
CREATE TABLE customers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    phone_number TEXT NOT NULL UNIQUE,
    full_name TEXT,
    language_pref TEXT DEFAULT 'ar', -- 'ar' or 'en'
    is_blocked BOOLEAN DEFAULT FALSE, -- Ability to block abusive customers
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 5. CUSTOMER ADDRESSES
-- Stored separately to allow multiple addresses per customer
CREATE TABLE customer_addresses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    customer_id BIGINT REFERENCES customers(id) ON DELETE CASCADE,
    address_text TEXT NOT NULL,
    latitude FLOAT NOT NULL,
    longitude FLOAT NOT NULL,
    label TEXT, -- e.g., "Home", "Work"
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 6. ORDERS
-- The core transactional table. Highly robust for analytics and history.
CREATE TABLE orders (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- Internal unique ID
    daily_seq INTEGER, -- Human readable #1, #2, #3 (Resets Daily)
    
    branch_id BIGINT REFERENCES branches(id),
    customer_id BIGINT REFERENCES customers(id),
    address_id BIGINT REFERENCES customer_addresses(id),
    
    -- Order Content
    items JSONB NOT NULL, -- [{"name": "Burger", "qty": 2, "price": 50, "options": [...]}]
    kitchen_notes TEXT, -- Notes for the chef (e.g., "No onions")

    -- Financials
    subtotal DECIMAL(10,2) DEFAULT 0.00,
    delivery_fee DECIMAL(10,2) DEFAULT 0.00,
    tax DECIMAL(10,2) DEFAULT 0.00,
    discount DECIMAL(10,2) DEFAULT 0.00,
    total_price DECIMAL(10,2) GENERATED ALWAYS AS (subtotal + delivery_fee + tax - discount) STORED,
    
    -- Payment Info
    payment_method payment_method DEFAULT 'cash',
    payment_status payment_status DEFAULT 'pending',

    -- Status Flow
    status order_status DEFAULT 'pending',
    
    -- Delivery Logistics (For "Out for Delivery" stage)
    delivery_agent_name TEXT,
    delivery_agent_phone TEXT,

    -- Exception Handling (Robustness)
    cancellation_reason TEXT, -- Required if status is 'cancelled'
    cancelled_by BIGINT REFERENCES system_users(id), -- Who cancelled it?
    customer_alert_message TEXT, -- Message sent to user for "Unusual Conditions" (e.g. "Late due to rain")

    -- Modification Tracking (New)
    modification_pending BOOLEAN DEFAULT FALSE,
    modification_request JSONB, -- Stores the proposed { items, notes, requested_at }

    -- Timestamps for KPI Analytics
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
    accepted_at TIMESTAMP WITH TIME ZONE,
    in_kitchen_at TIMESTAMP WITH TIME ZONE,
    out_for_delivery_at TIMESTAMP WITH TIME ZONE,
    done_at TIMESTAMP WITH TIME ZONE,
    cancelled_at TIMESTAMP WITH TIME ZONE
);

-- 7. INDEXES (PERFORMANCE)
-- Critical for dashboards filtering by status or date range
CREATE INDEX idx_orders_branch_id ON orders(branch_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_customers_phone ON customers(phone_number);

-- 8. REALTIME
alter publication supabase_realtime add table orders;

-- 9. SECURITY POLICIES (RLS - ROW LEVEL SECURITY)
-- Enable RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE branches ENABLE ROW LEVEL SECURITY;

-- 10. AUTOMATED DAILY ID GENERATION
-- This trigger calculates the next ID (1, 2, 3...) for the current day automatically
CREATE OR REPLACE FUNCTION set_daily_id()
RETURNS TRIGGER AS $$
BEGIN
  NEW.daily_seq := (
    SELECT COALESCE(MAX(daily_seq), 0) + 1
    FROM orders
    WHERE DATE(created_at) = DATE(NEW.created_at)
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_daily_id
BEFORE INSERT ON orders
FOR EACH ROW
EXECUTE FUNCTION set_daily_id();
